<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - CMS Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: #343a40;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            z-index: 1000;
        }

            .sidebar .nav-link {
                color: #fff;
                padding: 15px 20px;
                border-bottom: 1px solid #495057;
            }

                .sidebar .nav-link:hover {
                    background: #495057;
                    color: #fff;
                }

                .sidebar .nav-link.active {
                    background: #007bff;
                    color: #fff;
                }

        .main-content {
            margin-left: 250px;
            padding: 20px;
        }

        .dashboard-card {
            transition: transform 0.2s;
        }

            .dashboard-card:hover {
                transform: translateY(-5px);
            }

        .stat-icon {
            font-size: 2rem;
            opacity: 0.8;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @@keyframes spin {
            to

        {
            transform: rotate(360deg);
        }

        }

        .error-text {
            color: #dc3545;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-0">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-sticky">
                <div class="text-center py-4">
                    <h4 class="text-white">CMS Admin</h4>
                    <small class="text-muted">Welcome, Admin</small>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#dashboard">
                            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#news">
                            <i class="fas fa-newspaper me-2"></i>News (Haberler)
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#collections">
                            <i class="fas fa-layer-group me-2"></i>Collections
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#collection-groups">
                            <i class="fas fa-folder me-2"></i>Collection Groups
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#collection-products">
                            <i class="fas fa-box me-2"></i>Collection Products
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#users">
                            <i class="fas fa-users me-2"></i>User Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#audit-log">
                            <i class="fas fa-history me-2"></i>Audit Log
                        </a>
                    </li>
                    <li class="nav-item mt-3">
                        <a class="nav-link" href="#logout">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Main content -->
        <main class="main-content">
            <div class="d-flex justify-content-between align-items-center pb-2 mb-4 border-bottom">
                <div>
                    <h1 class="h2 mb-0">Dashboard</h1>
                    <small class="text-muted">Overview of your CMS content</small>
                </div>
                <div class="text-end">
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <span class="text-muted" id="lastUpdated">-</span>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-primary mb-3 dashboard-card">
                        <div class="card-header d-flex align-items-center">
                            <i class="fas fa-newspaper stat-icon me-2"></i>
                            <div>
                                <div class="fw-bold">News</div>
                                <small>Articles</small>
                            </div>
                        </div>
                        <div class="card-body">
                            <h3 class="card-title mb-0" id="newsCount">
                                <div class="loading"></div>
                            </h3>
                            <p class="card-text small mb-0">Total news articles</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-success mb-3 dashboard-card">
                        <div class="card-header d-flex align-items-center">
                            <i class="fas fa-layer-group stat-icon me-2"></i>
                            <div>
                                <div class="fw-bold">Collections</div>
                                <small>Main Categories</small>
                            </div>
                        </div>
                        <div class="card-body">
                            <h3 class="card-title mb-0" id="collectionsCount">
                                <div class="loading"></div>
                            </h3>
                            <p class="card-text small mb-0">Total collections</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-warning mb-3 dashboard-card">
                        <div class="card-header d-flex align-items-center">
                            <i class="fas fa-folder stat-icon me-2"></i>
                            <div>
                                <div class="fw-bold">Groups</div>
                                <small>Sub Categories</small>
                            </div>
                        </div>
                        <div class="card-body">
                            <h3 class="card-title mb-0" id="groupsCount">
                                <div class="loading"></div>
                            </h3>
                            <p class="card-text small mb-0">Collection groups</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-info mb-3 dashboard-card">
                        <div class="card-header d-flex align-items-center">
                            <i class="fas fa-box stat-icon me-2"></i>
                            <div>
                                <div class="fw-bold">Products</div>
                                <small>Items</small>
                            </div>
                        </div>
                        <div class="card-body">
                            <h3 class="card-title mb-0" id="productsCount">
                                <div class="loading"></div>
                            </h3>
                            <p class="card-text small mb-0">Collection products</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <button class="btn btn-outline-primary w-100 mb-2" onclick="navigateTo('news/create')">
                                        <i class="fas fa-plus me-2"></i>Add News Article
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-outline-success w-100 mb-2" onclick="navigateTo('collections/create')">
                                        <i class="fas fa-plus me-2"></i>Add Collection
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-outline-warning w-100 mb-2" onclick="navigateTo('collectiongroups/create')">
                                        <i class="fas fa-plus me-2"></i>Add Group
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-outline-info w-100 mb-2" onclick="navigateTo('collectionproducts/create')">
                                        <i class="fas fa-plus me-2"></i>Add Product
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Activity</h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="refreshActivity()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Action</th>
                                            <th>Table</th>
                                            <th>Date</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentActivity">
                                        <tr>
                                            <td colspan="4" class="text-center">
                                                <div class="loading"></div> Loading recent activity...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Dashboard functionality
        let dashboardData = {
            news: 0,
            collections: 0,
            groups: 0,
            products: 0
        };

        // Simulate API calls (replace with actual endpoints)
        async function loadDashboardStats() {
            try {
                // In real implementation, this would be: const response = await fetch('/Home/GetDashboardStats');
                // For demo purposes, we'll simulate data
                await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate loading delay

                // Simulated data - replace with actual API call
                const mockData = {
                    News: Math.floor(Math.random() * 50) + 10,
                    Collections: Math.floor(Math.random() * 20) + 5,
                    CollectionGroups: Math.floor(Math.random() * 30) + 8,
                    Products: Math.floor(Math.random() * 100) + 25
                };

                // Update dashboard
                updateDashboardStats(mockData);
                updateLastUpdated();

            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                showStatsError();
            }
        }

        async function loadRecentActivity() {
            try {
                // In real implementation: const response = await fetch('/AuditLog/GetRecentActivity');
                await new Promise(resolve => setTimeout(resolve, 800));

                // Simulated data - replace with actual API call
                const mockActivity = [
                    { username: 'admin', action: 'Create News', tableName: 'CMSContent', createdDate: new Date().toISOString() },
                    { username: 'admin', action: 'Login', tableName: 'Users', createdDate: new Date(Date.now() - 300000).toISOString() },
                    { username: 'admin', action: 'Create Collection', tableName: 'CMSBanner', createdDate: new Date(Date.now() - 600000).toISOString() },
                    { username: 'admin', action: 'Toggle Status', tableName: 'CMSContent', createdDate: new Date(Date.now() - 900000).toISOString() },
                    { username: 'admin', action: 'Create Product', tableName: 'CMSProduct', createdDate: new Date(Date.now() - 1200000).toISOString() }
                ];

                updateRecentActivity(mockActivity);

            } catch (error) {
                console.error('Error loading recent activity:', error);
                showActivityError();
            }
        }

        function updateDashboardStats(data) {
            document.getElementById('newsCount').textContent = data.News || 0;
            document.getElementById('collectionsCount').textContent = data.Collections || 0;
            document.getElementById('groupsCount').textContent = data.CollectionGroups || 0;
            document.getElementById('productsCount').textContent = data.Products || 0;
        }

        function updateRecentActivity(activities) {
            const tbody = document.getElementById('recentActivity');
            tbody.innerHTML = '';

            if (activities && activities.length > 0) {
                activities.forEach(activity => {
                    const badgeClass = getActionBadgeClass(activity.action);
                    const row = `
                        <tr>
                            <td>${activity.username}</td>
                            <td><span class="badge ${badgeClass}">${activity.action}</span></td>
                            <td>${activity.tableName}</td>
                            <td>${formatDate(activity.createdDate)}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No recent activity</td></tr>';
            }
        }

        function showStatsError() {
            ['newsCount', 'collectionsCount', 'groupsCount', 'productsCount'].forEach(id => {
                document.getElementById(id).innerHTML = '<span class="error-text">Error</span>';
            });
        }

        function showActivityError() {
            document.getElementById('recentActivity').innerHTML =
                '<tr><td colspan="4" class="text-center error-text">Error loading activity</td></tr>';
        }

        function getActionBadgeClass(action) {
            const actionLower = action.toLowerCase();
            if (actionLower.includes('login')) return 'bg-success';
            if (actionLower.includes('create')) return 'bg-primary';
            if (actionLower.includes('toggle') || actionLower.includes('change')) return 'bg-warning';
            if (actionLower.includes('delete')) return 'bg-danger';
            return 'bg-secondary';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function updateLastUpdated() {
            document.getElementById('lastUpdated').textContent =
                'Last updated: ' + new Date().toLocaleTimeString();
        }

        // Navigation functions
        function navigateTo(path) {
            // In real implementation: window.location.href = '/' + path;
            alert(`Navigate to: /${path}`);
        }

        function refreshDashboard() {
            // Show loading state
            ['newsCount', 'collectionsCount', 'groupsCount', 'productsCount'].forEach(id => {
                document.getElementById(id).innerHTML = '<div class="loading"></div>';
            });

            loadDashboardStats();
        }

        function refreshActivity() {
            document.getElementById('recentActivity').innerHTML =
                '<tr><td colspan="4" class="text-center"><div class="loading"></div> Loading...</td></tr>';
            loadRecentActivity();
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initializing...');
            loadDashboardStats();
            loadRecentActivity();
        });

        // Auto-refresh every 5 minutes
        setInterval(() => {
            loadDashboardStats();
            loadRecentActivity();
        }, 300000);
    </script>
</body>
</html>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loading...');

            // Load dashboard statistics
            fetch('/Home/GetDashboardStats')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Stats loaded:', data);
                    document.getElementById('newsCount').textContent = data.News || 0;
                    document.getElementById('collectionsCount').textContent = data.Collections || 0;
                    document.getElementById('groupsCount').textContent = data.CollectionGroups || 0;
                    document.getElementById('productsCount').textContent = data.Products || 0;
                })
                .catch(error => {
                    console.error('Error loading dashboard stats:', error);
                    // Show error state
                    document.getElementById('newsCount').textContent = 'Error';
                    document.getElementById('collectionsCount').textContent = 'Error';
                    document.getElementById('groupsCount').textContent = 'Error';
                    document.getElementById('productsCount').textContent = 'Error';
                });

            // Load recent activity
            fetch('/AuditLog/GetRecentActivity')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Activity loaded:', data);
                    const tbody = document.getElementById('recentActivity');
                    tbody.innerHTML = '';

                    if (data && data.length > 0) {
                        data.forEach(log => {
                            const badgeClass = getActionBadgeClass(log.action);
                            const row = `
                                <tr>
                                    <td>${log.username}</td>
                                    <td><span class="badge ${badgeClass}">${log.action}</span></td>
                                    <td>${log.tableName}</td>
                                    <td>${new Date(log.createdDate).toLocaleString()}</td>
                                </tr>
                            `;
                            tbody.innerHTML += row;
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center">No recent activity</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error loading recent activity:', error);
                    document.getElementById('recentActivity').innerHTML =
                        '<tr><td colspan="4" class="text-center text-danger">Error loading activity</td></tr>';
                });
        });

        function getActionBadgeClass(action) {
            const actionLower = action.toLowerCase();
            if (actionLower.includes('login')) return 'bg-success';
            if (actionLower.includes('create')) return 'bg-primary';
            if (actionLower.includes('toggle') || actionLower.includes('change')) return 'bg-warning';
            if (actionLower.includes('delete')) return 'bg-danger';
            return 'bg-secondary';
        }
    </script>
}